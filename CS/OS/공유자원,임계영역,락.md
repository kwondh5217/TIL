# 공유자원, 임계영역, 락

### 공유자원
공유자원이란 시스템 안에서 각 프로세스, 스레드가 함께 접근할 수 있는 자원을 뜻한다.

### 임계영역
둘 이상의 프로세스, 스레드가 공유 자원에 접근할 때 순서등의 이유로 결과가 달라지는 코드 영역을 뜻한다.

**임계영역을 해결하기 위한 조건**
1. **상호 배제(Mutual Exclusion)**: 임계 영역에 동시에 여러 프로세스가 접근할 수 없어야 한다. 즉, 하나의 프로세스가 임계 영역을 사용 중일 때는 다른 프로세스가 임계 영역에 진입할 수 없다.
2. **진행(Progress)**: 임계 영역에 진입하려는 프로세스가 없으면, 임계 영역에 진입하려는 프로세스 중 하나가 진입할 수 있도록 해야 한다. 임계 영역에 진입할 프로세스가 결정된 이후에는 결정 과정이 무한정 지연되지 않아야 한다.
3. **한정 대기(Bounded Waiting)**: 특정 프로세스가 임계 영역에 진입하려고 대기하는 시간이 한정되어 있어야 한다. 즉, 어떤 프로세스도 무한정 대기하지 않도록 해야 한다.
4. **융통성(Performance)**: 자원을 낭비하거나 불필요하게 시스템 성능을 저하시키지 않아야 한다. 시스템 자원의 효율적 사용을 보장해야 한다.


**경쟁 상태**
- 공유자원에 여러개의 스레드가 동시에 접근을 시도하는 것
- 경쟁 상태에서의 주의점은 의도한대로 코드가 동작하지 않을 가능성이 높다.
- 예를 들어 공유 자원인 money 변수의 초기값은 10이다. 스레드 A가 money 변수의 값에 10을 더하는 연산을 처리중에 스레드 B가 같은 작업을 수행하면 의도한 값인 30이 아니라, 20이 저장될 가능성이 높다.
- 운영체제에서 이는 심각한 오류이다. 효율적으로 CPU를 사용하기 위해 프로세스와 스레드로 CPU를 할당받으며 사용하는데, 제대로 된 결과값을 보장받지 못한다면 효율적이더라도 컴퓨터를 믿고 작업을 맡기지 못할 것이다.
- 따라서 운영체제에서는 임계영역을 정의하고 이를 관리하는 방법으로 락(lock)이라는 메커니즘을 사용한다.

### 락(lock)
락은 공유자원을 하나의 스레드, 프로세스가 사용하고 있을 때 다른 스레드나 프로세스에서 접근하지 못하도록 제한을 거는 것이다. 즉 하나의 스레드나 프로세스가 임계영역에 들어갈 때 락을 걸어서 다른 스레드나 프로세스의 접근을 차단하는 것이다.

**뮤텍스(mutex)**
- 프로세스나 스레드가 공유자원을 lock()을 통해 잠금 설정하고 사용한 후에는 unlock()을 통해 잠금 해제하는 메커니즘.
- 뮤텍스의 동작 방식
  1. **잠금 설정 (lock)**: 프로세스나 스레드가 공유 자원을 사용하기 전에 뮤텍스를 잠근다. 다른 프로세스나 스레드는 이 뮤텍스를 잠글 수 없다. 따라서, 현재 자원을 사용 중인 프로세스나 스레드만이 임계 영역에 접근할 수 있다.
  2. **잠금 해제 (unlock)**: 프로세스나 스레드가 공유 자원의 사용을 마친 후에는 뮤텍스를 해제한다. 이렇게 하면 다른 대기 중인 프로세스나 스레드가 뮤텍스를 잠그고 공유 자원에 접근할 수 있게 된다.
- Java에서 뮤텍스를 구현하는 방법으로는 java.util.concurrent.locks 패키지에 ReentrantLock 클래스를 사용하면 쉽게 구현이 가능하다.

**세마포어**
- 세마포어는 일반화된 뮤텍스로, 간단한 정수 값과 두 가지 주요 함수인 wait(P 연산), signal(V 연산)을 통해 공유 자원에 대한 접근을 제어하는 메커니즘입니다.
- 세마포어의 동작 방식
1. **정수 값**: 세마포어는 내부적으로 정수 값을 가진다. 이 정수 값은 세마포어가 허용하는 최대 동시 접근 가능 프로세스나 스레드의 수를 나타낸다.
2. **wait(P 연산)**: 프로세스나 스레드가 공유 자원에 접근하기 위해 호출한다. 이 함수는 세마포어의 정수 값을 확인하고, 접근이 가능하다면 정수 값을 감소시킨다. 만약 정수 값이 0 이하라면, 접근할 수 없음을 의미하므로 해당 프로세스나 스레드는 대기 상태로 전환된다.
3. **signal(V 연산)**: 프로세스나 스레드가 공유 자원에 대한 작업을 마친 후 호출하는 함수. 이 함수는 세마포어의 정수 값을 증가시키고, 대기 중인 다른 프로세스나 스레드에게 자원이 사용 가능함을 알린다.

- **바이너리 세마포어** : 0과 1의 두 가지 값만을 가질 수 있는 세마포어. 구현의 유사성으로 인해 뮤텍스와 비슷하지만 뮤텍스는 '**잠금 메커니즘**'이고, 세마포어는 신호를 기반으로 상호 배제가 일어나는 '**신호 메커니즘**'이다.
- **카운팅 세마포어** : 여러 개의 값을 가질 수 있는 세마포어이며, 여러 자원에 대한 접근을 제어하는 데 사용된다.

**모니터**
- 모니터는 둘 이상의 스레드나 프로세스가 공유자원에 안전하게 접근할 수 있도록 공유자원을 숨기고 접근에 대한 인터페이스를 제공하는 것
- 공유 자원에 접근하는 인터페이스로 모니터큐를 구현하여 스레드나 프로세스를 줄 세워서 관리하는 방식이다.
- 자바에서는 synchronized 키워드를 사용하여 구현이 가능하다.

**스핀락**
스핀락은 임계 구역에 진입하려는 스레드가 락을 획득할 때까지 반복적으로 확인하면서 바쁜 대기(busy-waiting)를 하는 방식이다.

**스핀락의 작동 원리**
1. **락 획득 시도**: 스레드는 락을 획득하기 위해 반복적으로 시도
2. **바쁜 대기(busy-waiting)**: 락이 이미 다른 스레드에 의해 획득되었다면, 락이 해제될 때까지 계속해서 락을 획득하려는 시도를 반복
3. **락 해제**: 임계 구역에 진입하여 작업을 완료한 스레드는 락을 해제

**장점**
1. **낮은 오버헤드**: 스핀락은 컨텍스트 스위치나 시스템 콜을 사용하지 않기 때문에 락 획득과 해제 시 오버헤드가 적다.
2. **빠른 락 획득**: 짧은 시간 동안 락을 획득해야 하는 경우 유용하다.

**단점**
1. **바쁜 대기(busy-waiting)**: 락을 획득할 때까지 계속 CPU를 사용하기 때문에, 오랜 시간 동안 락을 획득하지 못하면 CPU 자원을 낭비하게 된다.
2. **기아 상태(starvation)**: 특정 스레드나 프로세스가 공유 자원을 오랫동안 점유한다면, 다른 스레드들이 대기 상태에 갇힐 수 있다.

⠀
